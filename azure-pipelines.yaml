trigger:
  paths:
    include:
      - terraform/**
  branches:
    include:
      - main

variables:
  - group: infra-secrets
  - group: Terraform-Azure-Creds
  - group: Terraform-AWS-Creds   # <-- add AWS keys here

stages:
# -------------------------
# Stage 1: Azure Infra
# -------------------------
- stage: AzureInfra
  displayName: 'Provision Azure Infrastructure'
  jobs:
  - job: Terraform_Azure
    displayName: 'Terraform Apply (Azure)'
    pool:
      name: 'linux-hosted-agent-pool'

    steps:
    - task: DownloadSecureFile@1
      name: download_ssh_key
      inputs:
        secureFile: 'id_rsa_azure.pub'

    - script: |
        mkdir -p ~/.ssh
        cp $(download_ssh_key.secureFilePath) ~/.ssh/id_rsa.pub
        cp $(download_ssh_key.secureFilePath) terraform/modules/compute/id_rsa_azure.pub
      displayName: 'Prepare SSH Public Key for Terraform'

    - script: |
        echo "Generating pipeline.auto.tfvars for Azure"
        cat > terraform/pipeline.auto.tfvars <<EOF
        application_name      = "DevOps1-pm"
        environment           = "dev"
        location              = "North Europe"

        subscription_id       = "$(subscriptionId)"
        tenant_id             = "$(tenantId)"
        client_id             = "$(servicePrincipalId)"
        client_secret         = "$(servicePrincipalKey)"

        vm_size               = "Standard_B1s"
        admin_username        = "azureuser"
        admin_password        = "$(vmAdminPassword)"

        ssh_public_key        = "$(sshPublicKey)"
        vnet_address_space             = ["10.0.0.0/16"]
        public_subnet_address_prefixes = ["10.0.1.0/24"]
        EOF
      displayName: 'Generate pipeline.auto.tfvars'

    - script: |
        sudo apt-get update -y
        sudo apt-get install -y unzip curl
        TF_VERSION=1.9.5
        curl -fsSL https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_linux_amd64.zip -o tf.zip
        sudo unzip -o tf.zip -d /usr/local/bin
        terraform -version
      displayName: "Install Terraform"

    - task: AzureCLI@2
      displayName: "Terraform Init (Azure)"
      inputs:
        azureSubscription: 'azure-connection'
        scriptType: bash
        scriptLocation: inlineScript
        workingDirectory: $(System.DefaultWorkingDirectory)/terraform
        inlineScript: |
          terraform init -input=false

    - task: AzureCLI@2
      displayName: "Terraform Apply (Azure)"
      inputs:
        azureSubscription: 'azure-connection'
        scriptType: bash
        scriptLocation: inlineScript
        workingDirectory: $(System.DefaultWorkingDirectory)/terraform
        inlineScript: |
          terraform apply -input=false -auto-approve -var-file="pipeline.auto.tfvars"

    # Publish backend VM IP as pipeline artifact for Stage 2
    - script: |
        terraform output -raw backend_public_ip > backend_ip.txt
    - publish: backend_ip.txt
      artifact: azure-outputs

# -------------------------
# Stage 2: AWS DB
# -------------------------
- stage: AWSDB
  displayName: 'Provision AWS RDS MySQL'
  dependsOn: AzureInfra
  jobs:
  - job: Terraform_AWS
    displayName: 'Terraform Apply (AWS)'
    pool:
      name: 'linux-hosted-agent-pool'

    steps:
    - download: current
      artifact: azure-outputs

    - script: |
        BACKEND_IP=$(cat $(Pipeline.Workspace)/azure-outputs/backend_ip.txt)
        cat > terraform/aws.auto.tfvars <<EOF
        backend_vm_public_ip = "${BACKEND_IP}"
        mysql_admin_username = "mysqladmin"
        mysql_admin_password = "$(mysqlAdminPassword)"
        mysql_database_name  = "bookreviews_dev"
        EOF
      displayName: "Generate aws.auto.tfvars"

    - script: |
        terraform init -input=false
      workingDirectory: $(System.DefaultWorkingDirectory)/terraform
      displayName: "Terraform Init (AWS)"
      env:
        AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
        AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
        AWS_DEFAULT_REGION: $(AWS_DEFAULT_REGION)

    - script: |
        terraform apply -input=false -auto-approve -var-file="aws.auto.tfvars"
      workingDirectory: $(System.DefaultWorkingDirectory)/terraform
      displayName: "Terraform Apply (AWS)"
      env:
        AWS_ACCESS_KEY_ID: $(AWS_ACCESS_KEY_ID)
        AWS_SECRET_ACCESS_KEY: $(AWS_SECRET_ACCESS_KEY)
        AWS_DEFAULT_REGION: $(AWS_DEFAULT_REGION)
