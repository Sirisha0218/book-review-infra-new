trigger:
  paths:
    include:
      - terraform/**
  branches:
    include:
      - main

stages:
- stage: Terraform
  displayName: 'Provision Infrastructure'
  jobs:
  - job: Terraform_Apply
    displayName: 'Terraform Apply'
    pool:
      name: 'linux-hosted-agent-pool'

    steps:
    # Download the SSH public key you uploaded as a secure file
    - task: DownloadSecureFile@1
      name: download_ssh_key
      inputs:
        secureFile: 'id_rsa_azure.pub'

    - script: |
        echo "Copying SSH public key into Terraform module"

        mkdir -p ~/.ssh
        cp $(download_ssh_key.secureFilePath) ~/.ssh/id_rsa.pub

        # Copy into Terraform module path so file() calls succeed
        cp $(download_ssh_key.secureFilePath) terraform/modules/compute/id_rsa_azure.pub

        echo "Listing contents of terraform/modules/compute/"
        ls -al terraform/modules/compute/
      displayName: 'Prepare SSH Public Key for Terraform'

    # Generate pipeline.auto.tfvars from variable group values
    - script: |
        echo "Generating pipeline.auto.tfvars with secrets and config"
        cat > terraform/pipeline.auto.tfvars <<EOF
        subscription_id       = "$(subscriptionId)"
        tenant_id             = "$(tenantId)"
        client_id             = "$(servicePrincipalId)"
        client_secret         = "$(servicePrincipalKey)"
        ssh_public_key        = file("modules/compute/id_rsa_azure.pub")
        admin_password        = "$(vmAdminPassword)"
        mysql_admin_password  = "$(mysqlAdminPassword)"
        EOF
      displayName: 'Generate pipeline.auto.tfvars'

    - script: |
        sudo apt-get update -y
        sudo apt-get install -y unzip curl
        TF_VERSION=1.9.5
        curl -fsSL https://releases.hashicorp.com/terraform/${TF_VERSION}/terraform_${TF_VERSION}_linux_amd64.zip -o tf.zip
        sudo unzip -o tf.zip -d /usr/local/bin
        terraform -version
      displayName: "Install Terraform"


    # Run Terraform with Azure CLI context
    - task: AzureCLI@2
      displayName: "Terraform Init"
      inputs:
        azureSubscription: 'azure-connection'
        scriptType: bash
        scriptLocation: inlineScript
        workingDirectory: $(System.DefaultWorkingDirectory)/terraform
        inlineScript: |
          terraform init -input=false

    - task: AzureCLI@2
      displayName: "Terraform Plan"
      inputs:
        azureSubscription: 'azure-connection'
        scriptType: bash
        scriptLocation: inlineScript
        workingDirectory: $(System.DefaultWorkingDirectory)/terraform
        inlineScript: |
          terraform plan -input=false -var-file="pipeline.auto.tfvars"

    - task: AzureCLI@2
      displayName: "Terraform Apply"
      inputs:
        azureSubscription: 'azure-connection'
        scriptType: bash
        scriptLocation: inlineScript
        workingDirectory: $(System.DefaultWorkingDirectory)/terraform
        inlineScript: |
          terraform apply -input=false -auto-approve -var-file="pipeline.auto.tfvars"

